{
    "version": "https://jsonfeed.org/version/1",
    "title": "PyQt • All posts by \"截图\" tag",
    "description": "Python PyQt PyQt6 PyQt5 PyQt4 PySide PySide2 PySide6",
    "home_page_url": "https://pyqt5.com",
    "items": [
        {
            "id": "https://pyqt5.com/calljava.html",
            "url": "https://pyqt5.com/calljava.html",
            "title": "Python调用Java对Excel截图",
            "date_published": "2019-03-12T13:15:06.000Z",
            "content_html": "<p>有的时候会遇到一些奇葩的需求，就是用 Excel 做报表，但是需要对里面的数据进行填充并生成报表图片，发送出去。这里记录用 python 调用 jar 包对 excel 文件进行公式计算和截图，数据填充可以用 xlrd 或者 openpyxl</p>\n<span id=\"more\"></span>\n<p>利用 <code>jpype</code>  模块初始化 java 虚拟机加载 jar 包然后执行其中的功能。</p>\n<h2 id=\"代码\"><a class=\"markdownIt-Anchor\" href=\"#代码\">#</a> 代码</h2>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#!/usr/bin/env python</span>\n<span class=\"token comment\"># -*- coding: utf-8 -*-</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nCreated on 2019年3月12日\n@author: Irony\n@site: https://pyqt5.com https://github.com/892768447\n@email: 892768447@qq.com\n@file: CallJava\n@description: \n\"\"\"</span>\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">import</span> jpype\n\n\n__Author__ <span class=\"token operator\">=</span> <span class=\"token string\">'Irony'</span>\n__Copyright__ <span class=\"token operator\">=</span> <span class=\"token string\">'Copyright (c) 2019'</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">convertToImage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    Workbook <span class=\"token operator\">=</span> jpype<span class=\"token punctuation\">.</span>JClass<span class=\"token punctuation\">(</span><span class=\"token string\">'com.aspose.cells.Workbook'</span><span class=\"token punctuation\">)</span>\n    ImageFormat <span class=\"token operator\">=</span> jpype<span class=\"token punctuation\">.</span>JClass<span class=\"token punctuation\">(</span><span class=\"token string\">'com.aspose.cells.ImageFormat'</span><span class=\"token punctuation\">)</span>\n    ImageOrPrintOptions <span class=\"token operator\">=</span> jpype<span class=\"token punctuation\">.</span>JClass<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'com.aspose.cells.ImageOrPrintOptions'</span><span class=\"token punctuation\">)</span>\n    SheetRender <span class=\"token operator\">=</span> jpype<span class=\"token punctuation\">.</span>JClass<span class=\"token punctuation\">(</span><span class=\"token string\">'com.aspose.cells.SheetRender'</span><span class=\"token punctuation\">)</span>\n\n    book <span class=\"token operator\">=</span> Workbook<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>abspath<span class=\"token punctuation\">(</span><span class=\"token string\">'data/test.xlsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 保存为html</span>\n    book<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">'data/index.html'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 保存为pdf</span>\n    book<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">'data/test.pdf'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 截图</span>\n    imgOptions <span class=\"token operator\">=</span> ImageOrPrintOptions<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># imgOptions.setQuality(100)</span>\n    imgOptions<span class=\"token punctuation\">.</span>setOnePagePerSheet<span class=\"token punctuation\">(</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 输出图片格式</span>\n<span class=\"token comment\">#     imgOptions.setImageFormat(ImageFormat.getJpeg())</span>\n    imgOptions<span class=\"token punctuation\">.</span>setImageFormat<span class=\"token punctuation\">(</span>ImageFormat<span class=\"token punctuation\">.</span>getPng<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 计算</span>\n    CalculationOptions <span class=\"token operator\">=</span> jpype<span class=\"token punctuation\">.</span>JClass<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'com.aspose.cells.CalculationOptions'</span><span class=\"token punctuation\">)</span>\n    opt <span class=\"token operator\">=</span> CalculationOptions<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 对Sheet1中的公式进行计算</span>\n    sheet <span class=\"token operator\">=</span> book<span class=\"token punctuation\">.</span>getWorksheets<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'Sheet1'</span><span class=\"token punctuation\">)</span>\n    sheet<span class=\"token punctuation\">.</span>calculateFormula<span class=\"token punctuation\">(</span>opt<span class=\"token punctuation\">,</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 设置区域</span>\n    pageSetup <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span>getPageSetup<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 去掉边距</span>\n    pageSetup<span class=\"token punctuation\">.</span>setBottomMargin<span class=\"token punctuation\">(</span><span class=\"token number\">0.</span><span class=\"token punctuation\">)</span>\n    pageSetup<span class=\"token punctuation\">.</span>setLeftMargin<span class=\"token punctuation\">(</span><span class=\"token number\">0.</span><span class=\"token punctuation\">)</span>\n    pageSetup<span class=\"token punctuation\">.</span>setRightMargin<span class=\"token punctuation\">(</span><span class=\"token number\">0.</span><span class=\"token punctuation\">)</span>\n    pageSetup<span class=\"token punctuation\">.</span>setTopMargin<span class=\"token punctuation\">(</span><span class=\"token number\">0.</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 设置要截图的区域(对角线)</span>\n    pageSetup<span class=\"token punctuation\">.</span>setPrintArea<span class=\"token punctuation\">(</span><span class=\"token string\">'A0:C2'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Create a SheetRender object for the target sheet</span>\n    sr <span class=\"token operator\">=</span> SheetRender<span class=\"token punctuation\">(</span>sheet<span class=\"token punctuation\">,</span> imgOptions<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> page <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>sr<span class=\"token punctuation\">.</span>getPageCount<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Generate an image for the worksheet</span>\n        sr<span class=\"token punctuation\">.</span>toImage<span class=\"token punctuation\">(</span>\n            page<span class=\"token punctuation\">,</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'%d.png'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>page <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># emm这里不知道什么用绝对路径就报错</span>\n    libs <span class=\"token operator\">=</span> <span class=\"token string\">'&#123;&#125;;&#123;&#125;'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'libs/bcprov-jdk16-146.jar'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'libs/aspose-cells-19.2.jar'</span>\n    <span class=\"token punctuation\">)</span>\n    command <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>jpype<span class=\"token punctuation\">.</span>getDefaultJVMPath<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                   <span class=\"token string\">'-ea'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xmn128m'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xms512M'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xmx512M'</span><span class=\"token punctuation\">,</span>\n                   <span class=\"token string\">'-Djava.class.path=&#123;0&#125;'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>libs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span>\n    jpype<span class=\"token punctuation\">.</span>startJVM<span class=\"token punctuation\">(</span>jpype<span class=\"token punctuation\">.</span>getDefaultJVMPath<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                   <span class=\"token string\">'-ea'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xmn128m'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xms512M'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-Xmx512M'</span><span class=\"token punctuation\">,</span>\n                   <span class=\"token string\">'-Djava.class.path=&#123;0&#125;'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>libs<span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 解决多线程问题</span>\n    jpype<span class=\"token punctuation\">.</span>attachThreadToJVM<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 对excel截图</span>\n    convertToImage<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 关闭虚拟机</span>\n    jpype<span class=\"token punctuation\">.</span>shutdownJVM<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'截图完成'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    test<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"附件\"><a class=\"markdownIt-Anchor\" href=\"#附件\">#</a> 附件</h2>\n<p><a href=\"/files/%E8%B0%83%E7%94%A8java%E7%94%9F%E6%88%90%E6%8A%A5%E8%A1%A8.7z\">调用 java 生成报表.7z</a></p>\n<p>解压后进入 whls 文件夹安装对应版本的 jpype 包</p>\n<h2 id=\"效果图\"><a class=\"markdownIt-Anchor\" href=\"#效果图\">#</a> 效果图</h2>\n<p><img src=\"/images/calljava.png\" alt=\"calljava\"></p>\n",
            "tags": [
                "Python",
                "截图"
            ]
        }
    ]
}